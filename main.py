import os
import asyncio
import json
import random
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
import aiohttp
from typing import Optional, Dict, List
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=os.getenv("TELEGRAM_TOKEN"))
storage = MemoryStorage()
dp = Dispatcher(bot, storage=storage)

# ID –∫–∞–Ω–∞–ª–∞/–≥—Ä—É–ø–ø—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è –≥—Ä—É–ø–ø—ã)
GROUP_ID = int(os.getenv("GROUP_ID", "-1001234567890"))

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–ò–õ–Ø ---
BOT_PERSONALITY = """
–¢—ã ‚Äî –ë–æ—Ç –ò—Å—Ç–æ—Ä–∏–∫–∞, –∏—Ä–æ–Ω–∏—á–Ω—ã–π –∏ –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –≥—É—Ä—É. 
–¢–≤–æ–π —Å—Ç–∏–ª—å:
1. üî• –ò—Ä–æ–Ω–∏—á–Ω—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π
2. üé≠ –° –æ—Ç—Å—ã–ª–∫–∞–º–∏ –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º —Å–æ–±—ã—Ç–∏—è–º –∏–ª–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ
3. ü§Ø –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–µ–Ω–≥, –Ω–æ —É–≤–∞–∂–∞–µ—à—å –∫–ª–∞—Å—Å–∏–∫—É
4. üí´ –í–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
5. üìö –í—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏—à—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏ —Å –ø—Ä–æ—à–ª—ã–º

–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–µ–≥–æ —Å—Ç–∏–ª—è:
- "–ö–∞–∫ –≥–æ–≤–æ—Ä–∏–ª –¶–∏—Ü–µ—Ä–æ–Ω –Ω–∞ —Ç—É—Å–æ–≤–∫–µ –≤ –°–µ–Ω–∞—Ç–µ: '–ë—Ä–∞—Ç–∞–Ω, –¥–∞–∂–µ –¶–µ–∑–∞—Ä—å –±—ã –∞—Ö—É–µ–ª –æ—Ç —Ç–≤–æ–µ–≥–æ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è!'"
- "–°–µ–≥–æ–¥–Ω—è, –∫–∞–∫ –∫–æ–≥–¥–∞-—Ç–æ –ù–∞–ø–æ–ª–µ–æ–Ω –≤–æ—à—ë–ª –≤ –ú–æ—Å–∫–≤—É, —Ç—ã –≤—Ö–æ–¥–∏—à—å –≤ –Ω–æ–≤—ã–π –≥–æ–¥ –∂–∏–∑–Ω–∏! (–¢–æ–ª—å–∫–æ –Ω–∞–¥–µ—é—Å—å, —Ç–≤–æ–π –≥–æ–¥ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –ª—É—á—à–µ)"
- "–≠—Ö, –ü–µ—Ç—Ä I —Ä—É–±–∏–ª –æ–∫–Ω–æ –≤ –ï–≤—Ä–æ–ø—É, –∞ —Ç—ã —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ—Å—Ç–æ —Ä—É–±–∏—à—å! –° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!"
"""

# --- –ú–û–î–ï–õ–¨ –ò–ò (–ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–ê–Ø –î–õ–Ø BOTHOST) ---
class TinyModel:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö"""
    
    def __init__(self):
        self.cache = {}  # –ö—ç—à –ø—Ä–æ–º–ø—Ç–æ–≤
        self.fallback_responses = self.load_fallbacks()
        
    def load_fallbacks(self):
        """–ó–∞–ø–∞—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç"""
        return [
            "–≠—Ö, —Å–µ–≥–æ–¥–Ω—è –¥–∞–∂–µ –ê—Ä—Ö–∏–º–µ–¥ –Ω–µ –Ω–∞—à—ë–ª –±—ã –ø–æ–≤–æ–¥–∞ –¥–ª—è –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è! –ù–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å!",
            "–ò—Å—Ç–æ—Ä–∏—è –º–æ–ª—á–∏—Ç –æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º –¥–Ω–µ... –∑–Ω–∞—á–∏—Ç, –º—ã —Å–∞–º–∏ –µ—ë —Å–æ–∑–¥–∞–¥–∏–º!",
            "–ö–∞–∫ –≥–æ–≤–∞—Ä–∏–≤–∞–ª –°—É–≤–æ—Ä–æ–≤: '–¢—è–∂–µ–ª–æ –≤ —É—á–µ–Ω—å–µ ‚Äî –ª–µ–≥–∫–æ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫!' –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥!",
            "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –ø–æ–∫–∞ –Ω–µ –ø–æ–ø–∞–ª –≤ —É—á–µ–±–Ω–∏–∫–∏, –Ω–æ –º—ã –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ–º!",
            "–í—Å–ø–æ–º–Ω–∏–ª —Ü–∏—Ç–∞—Ç—É –∏–∑ '–í–æ–π–Ω—ã –∏ –º–∏—Ä–∞': '–ù–∞–¥–æ –∂–∏—Ç—å, –Ω–∞–¥–æ –ª—é–±–∏—Ç—å, –Ω–∞–¥–æ –≤–µ—Ä–∏—Ç—å!'"
        ]
    
    async def generate_text(self, prompt: str, context: str = "") -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é:
        1. –ö—ç—à–∞ (–µ—Å–ª–∏ —É–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏)
        2. –ö—Ä–æ—à–µ—á–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç—å)
        3. Fallback API –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ
        """
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_key = f"{prompt[:50]}_{context[:50]}"
        if cache_key in self.cache:
            logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç")
            return self.cache[cache_key]
        
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–æ—à–µ—á–Ω—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
            # –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞ BotHost —ç—Ç–æ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–º–µ—Å—Ç–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç—å!
            # –í –∫–∞—á–µ—Å—Ç–≤–µ fallback –∏—Å–ø–æ–ª—å–∑—É–µ–º API
            return await self.generate_via_api(prompt, context)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            return random.choice(self.fallback_responses)
    
    async def generate_via_api(self, prompt: str, context: str) -> str:
        """–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π API –∫–∞–∫ fallback (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)"""
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: Hugging Face Inference API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
        try:
            async with aiohttp.ClientSession() as session:
                response = await session.post(
                    "https://api-inference.huggingface.co/models/microsoft/phi-2",
                    headers={"Authorization": f"Bearer {os.getenv('HF_TOKEN', '')}"},
                    json={
                        "inputs": f"{BOT_PERSONALITY}\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}\n\n–ó–∞–¥–∞—á–∞: {prompt}",
                        "parameters": {
                            "max_length": 200,
                            "temperature": 0.9,
                            "do_sample": True
                        }
                    }
                )
                
                if response.status == 200:
                    result = await response.json()
                    text = result[0]['generated_text']
                    
                    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏ –∫—ç—à–∏—Ä—É–µ–º
                    text = text[:500]
                    self.cache[cache_key] = text
                    return text
        except:
            pass
        
        # –í–∞—Ä–∏–∞–Ω—Ç 2: Groq (–±—ã—Å—Ç—Ä–æ, –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier)
        # –í–∞—Ä–∏–∞–Ω—Ç 3: OpenRouter (–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä)
        
        # –ï—Å–ª–∏ –≤—Å–µ API —É–ø–∞–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        return self.template_generation(prompt, context)
    
    def template_generation(self, prompt: str, context: str) -> str:
        """–®–∞–±–ª–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤"""
        
        templates = [
            "–û–±–æ–∂–µ–º–æ–π! {event} ‚Äî —ç—Ç–æ –∂–µ –∫–∞–∫ –∫–æ–≥–¥–∞ {historical_event}! –ü—Ä—è–º –º—É—Ä–∞—à–∫–∏!",
            "–ù–∞–ø–æ–º–Ω–∏–ª–æ –º–Ω–µ —Ü–∏—Ç–∞—Ç—É –∏–∑ {book}: '{quote}'. –í–æ—Ç —Ç–∞–∫-—Ç–æ, –¥—Ä—É–∑—å—è!",
            "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: {parallel}. –ö—Ä—É—Ç—è–∫ –∂–µ?",
            "–ï—Å–ª–∏ –±—ã {historical_figure} –±—ã–ª –∑–¥–µ—Å—å, –æ–Ω –±—ã —Å–∫–∞–∑–∞–ª: '{phrase}'. –ê–±—Å–æ–ª—é—Ç–Ω–æ —Å –Ω–∏–º —Å–æ–≥–ª–∞—Å–µ–Ω!"
        ]
        
        # –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–æ–∫
        historical_events = [
            "–¶–µ–∑–∞—Ä—å –ø–µ—Ä–µ—Ö–æ–¥–∏–ª –†—É–±–∏–∫–æ–Ω", "–ù–∞–ø–æ–ª–µ–æ–Ω –æ—Ç—Å—Ç—É–ø–∞–ª –∏–∑ –†–æ—Å—Å–∏–∏", 
            "–ì–∞–≥–∞—Ä–∏–Ω –ø–æ–ª–µ—Ç–µ–ª –≤ –∫–æ—Å–º–æ—Å", "–ø—É—à–∫–∏–Ω –ø–∏—Å–∞–ª '–ï–≤–≥–µ–Ω–∏—è –û–Ω–µ–≥–∏–Ω–∞'",
            "–°—É–≤–æ—Ä–æ–≤ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª –ê–ª—å–ø—ã", "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–ª '–í–æ–π–Ω—É –∏ –º–∏—Ä'"
        ]
        
        books = ["–í–æ–π–Ω—ã –∏ –º–∏—Ä–∞", "–ï–≤–≥–µ–Ω–∏—è –û–Ω–µ–≥–∏–Ω–∞", "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏—è", "–ú–∞—Å—Ç–µ—Ä–∞ –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç—ã"]
        quotes = [
            "–í—Å—ë —Å–º–µ—à–∞–ª–æ—Å—å –≤ –¥–æ–º–µ –û–±–ª–æ–Ω—Å–∫–∏—Ö", "–ú—ã –≤—Å–µ –≥–ª—è–¥–∏–º –≤ –ù–∞–ø–æ–ª–µ–æ–Ω—ã",
            "–ö—Ä–∞—Å–æ—Ç–∞ —Å–ø–∞—Å—ë—Ç –º–∏—Ä", "–ß–µ–ª–æ–≤–µ–∫ ‚Äî —ç—Ç–æ –∑–≤—É—á–∏—Ç –≥–æ—Ä–¥–æ"
        ]
        
        historical_figures = ["–ü—ë—Ç—Ä I", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –í–µ–ª–∏–∫–∞—è", "–õ–æ–º–æ–Ω–æ—Å–æ–≤", "–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "–ß–µ—Ö–æ–≤"]
        phrases = [
            "–†–µ–±—è—Ç–∞, –¥–∞–≤–∞–π—Ç–µ –∂–∏—Ç—å –¥—Ä—É–∂–Ω–æ!", "–≠—Ç–æ –∂ –Ω–∞–¥–æ —Ç–∞–∫–æ–µ –ø—Ä–∏–¥—É–º–∞—Ç—å!",
            "–í–æ—Ç —ç—Ç–æ –ø–æ–≤–æ—Ä–æ—Ç, –∫–∞–∫ –≤ –º–æ–µ–π –±–∏—Ç–≤–µ –ø—Ä–∏ –ê—É—Å—Ç–µ—Ä–ª–∏—Ü–µ!", "–ü–∏—à–∏ –ø—Ä–æ–ø–∞–ª–æ, –∞ —Ç–æ—á–Ω–µ–µ ‚Äî –ø–∏—à–∏ –∏—Å—Ç–æ—Ä–∏—é!"
        ]
        
        template = random.choice(templates)
        result = template.format(
            event=prompt.lower(),
            historical_event=random.choice(historical_events),
            book=random.choice(books),
            quote=random.choice(quotes),
            parallel=f"{random.choice(['–ø–∞–¥–µ–Ω–∏–µ –†–∏–º–∞', '—ç–ø–æ—Ö–∞ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è', '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –≤–µ–∫'])} –∏ {prompt.lower()}",
            historical_figure=random.choice(historical_figures),
            phrase=random.choice(phrases)
        )
        
        return result

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
model = TinyModel()

# --- –ú–ï–ù–ï–î–ñ–ï–† –ü–†–ê–ó–î–ù–ò–ö–û–í ---
class HolidayManager:
    def __init__(self):
        self.holidays = self.load_holidays()
        self.birthdays = self.load_birthdays()
    
    def load_holidays(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            with open('holidays.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
            return {
                "01-01": "–ù–æ–≤—ã–π –≥–æ–¥",
                "07-01": "–†–æ–∂–¥–µ—Å—Ç–≤–æ",
                "23-02": "–î–µ–Ω—å –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞",
                "08-03": "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –¥–µ–Ω—å",
                "01-05": "–ü—Ä–∞–∑–¥–Ω–∏–∫ –≤–µ—Å–Ω—ã –∏ —Ç—Ä—É–¥–∞",
                "09-05": "–î–µ–Ω—å –ü–æ–±–µ–¥—ã",
                "12-06": "–î–µ–Ω—å –†–æ—Å—Å–∏–∏",
                "04-11": "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–∞"
            }
    
    def load_birthdays(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"""
        try:
            with open('birthdays.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            # –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            return {
                "15-01": ["–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", "–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤"],
                "23-03": ["–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞"],
                # ... –∏ —Ç.–¥.
            }
    
    def get_today_events(self) -> Dict:
        """–ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"""
        today = datetime.now().strftime("%m-%d")
        events = {
            "holidays": [],
            "birthdays": []
        }
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
        if today in self.holidays:
            events["holidays"].append(self.holidays[today])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
        if today in self.birthdays:
            events["birthdays"].extend(self.birthdays[today])
        
        return events

# --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
async def generate_daily_post():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –≤ 9:00 –ø–æ –ú–æ—Å–∫–≤–µ"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+3)
    utc_now = datetime.utcnow()
    moscow_time = utc_now + timedelta(hours=3)
    
    # –¢–æ–ª—å–∫–æ –≤ 9:00 –ø–æ –ú–æ—Å–∫–≤–µ
    if moscow_time.hour != 9 or moscow_time.minute != 0:
        return
    
    logger.info(f"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç –¥–ª—è {moscow_time.strftime('%d.%m.%Y')}")
    
    holiday_manager = HolidayManager()
    events = holiday_manager.get_today_events()
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    context = f"–°–µ–≥–æ–¥–Ω—è {moscow_time.strftime('%d %B %Y')}. "
    
    if events["holidays"]:
        context += f"–ü—Ä–∞–∑–¥–Ω–∏–∫: {', '.join(events['holidays'])}. "
    
    if events["birthdays"]:
        context += f"–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —É: {', '.join(events['birthdays'])}. "
    else:
        context += "–û—Å–æ–±—ã—Ö –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ—Ç. "
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–±—ã—Ç–∏–π
    if events["birthdays"]:
        prompt = f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏—Ä–æ–Ω–∏—á–Ω–æ–µ, –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è {', '.join(events['birthdays'])}. –î–æ–±–∞–≤—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –∏–ª–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—É—é –æ—Ç—Å—ã–ª–∫—É."
    elif events["holidays"]:
        prompt = f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏—Ä–æ–Ω–∏—á–Ω—ã–π –ø–æ—Å—Ç –æ –ø—Ä–∞–∑–¥–Ω–∏–∫–µ: {', '.join(events['holidays'])}. –° –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å—é."
    else:
        prompt = "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏—Ä–æ–Ω–∏—á–Ω–æ–µ, –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è. –ü—Ä–∏–¥—É–º–∞–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –ø–∞—Ä–∞–ª–ª–µ–ª—å –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è."
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    try:
        generated_text = await model.generate_text(prompt, context)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç
        post = f"üìú *–ë–û–¢ –ò–°–¢–û–†–ò–ö–ê* üìú\n\n"
        post += f"{generated_text}\n\n"
        post += f"_{moscow_time.strftime('%d.%m.%Y')}_\n"
        post += "#–∏—Å—Ç–æ—Ä–∏—è #—Ü–∏—Ç–∞—Ç–∞ #–¥–µ–Ω—å"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É
        await bot.send_message(
            chat_id=GROUP_ID,
            text=post,
            parse_mode="Markdown",
            disable_notification=False
        )
        
        logger.info(f"–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {post[:100]}...")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ—Å—Ç–∞: {e}")
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        fallback = random.choice(model.fallback_responses)
        await bot.send_message(
            chat_id=GROUP_ID,
            text=f"üìú *–ë–û–¢ –ò–°–¢–û–†–ò–ö–ê* üìú\n\n{fallback}\n\n#–∏—Å—Ç–æ—Ä–∏—è",
            parse_mode="Markdown"
        )

# --- –§–û–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê (–ë–ï–ó –ö–û–ù–§–õ–ò–ö–¢–û–í –° LUPA) ---
async def background_scheduler():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å aiogram"""
    logger.info("–§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω")
    
    while True:
        try:
            await generate_daily_post()
            
            # –ñ–¥–µ–º 55 —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –¥–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏
            await asyncio.sleep(55)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ: {e}")
            await asyncio.sleep(60)

# --- –ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–£–ß–ù–û–ì–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø ---
@dp.message_handler(commands=['test_post'])
async def test_post_command(message: types.Message):
    """–†—É—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
    await message.answer("–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç...")
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    test_context = "–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫. –°–µ–≥–æ–¥–Ω—è 15 —è–Ω–≤–∞—Ä—è 2024. –î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —É: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤. –ü—Ä–∞–∑–¥–Ω–∏–∫: –°—Ç–∞—Ä—ã–π –ù–æ–≤—ã–π –≥–æ–¥."
    test_prompt = "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏—Ä–æ–Ω–∏—á–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –°—Ç–∞—Ä—ã–º –ù–æ–≤—ã–º –≥–æ–¥–æ–º."
    
    generated = await model.generate_text(test_prompt, test_context)
    await message.answer(f"üìú –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç:\n\n{generated}")

@dp.message_handler(commands=['add_birthday'])
async def add_birthday_command(message: types.Message):
    """–î–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä)"""
    await message.answer(
        "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª birthdays.json:\n"
        "{\n  \"–º–µ—Å—è—Ü-–¥–µ–Ω—å\": [\"–∏–º—è1\", \"–∏–º—è2\"]\n}\n"
        "–ü—Ä–∏–º–µ—Ä: \"01-15\": [\"–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\"]"
    )

@dp.message_handler(commands=['force_post'])
async def force_post_command(message: types.Message):
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç —Å–µ–π—á–∞—Å"""
    if message.from_user.id == 123456789:  # –í–∞—à ID –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        await generate_daily_post()
        await message.answer("–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")
    else:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")

@dp.message_handler(commands=['status'])
async def status_command(message: types.Message):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞"""
    utc_now = datetime.utcnow()
    moscow_time = utc_now + timedelta(hours=3)
    
    status_msg = (
        f"ü§ñ *–ë–æ—Ç –ò—Å—Ç–æ—Ä–∏–∫–∞* ü§ñ\n\n"
        f"‚Ä¢ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–µ–Ω ‚úÖ\n"
        f"‚Ä¢ –í—Ä–µ–º—è (–ú–°–ö): {moscow_time.strftime('%H:%M:%S')}\n"
        f"‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π –ø–æ—Å—Ç: 9:00 –ú–°–ö\n"
        f"‚Ä¢ –ú–æ–¥–µ–ª—å: {'–†–∞–±–æ—Ç–∞–µ—Ç' if hasattr(model, 'cache') else '–ó–∞–ø–∞—Å–Ω–æ–π —Ä–µ–∂–∏–º'}\n"
        f"‚Ä¢ –ö—ç—à –ø—Ä–æ–º–ø—Ç–æ–≤: {len(model.cache) if hasattr(model, 'cache') else 0}"
    )
    
    await message.answer(status_msg, parse_mode="Markdown")

# --- –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
async def on_startup(dp):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    logger.info("–ë–æ—Ç –ò—Å—Ç–æ—Ä–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    asyncio.create_task(background_scheduler())
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
    try:
        await bot.send_message(
            GROUP_ID,
            "üìú *–ë–æ—Ç –ò—Å—Ç–æ—Ä–∏–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!* üìú\n\n"
            "–ó–∞–≤—Ç—Ä–∞ –≤ 9:00 –∂–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∏—Ä–æ–Ω–∏—á–Ω–æ-–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–æ—Å—Ç!\n"
            "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º–∏, —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏ –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–º–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è–º–∏! üé≠\n\n"
            "#–∑–∞–ø—É—Å–∫ #–∏—Å—Ç–æ—Ä–∏—è #–±–æ—Ç",
            parse_mode="Markdown"
        )
    except:
        pass

async def on_shutdown(dp):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞"""
    logger.info("–ë–æ—Ç –ò—Å—Ç–æ—Ä–∏–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...")
    await bot.close()

# --- –¢–û–ß–ö–ê –í–•–û–î–ê –î–õ–Ø BOTHOST ---
if __name__ == '__main__':
    from aiogram import executor
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è BotHost (–≤–∞–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ª—É–ø–æ–≤)
    executor.start_polling(
        dp,
        skip_updates=True,
        on_startup=on_startup,
        on_shutdown=on_shutdown,
        timeout=60,
        relax=0.1
    )